<div class="client-profile-container">
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading profile...</p>
  </div>

  <div *ngIf="error && !isLoading" class="error-container">
    <div class="error-message">
      <i class="fas fa-exclamation-triangle"></i>
      <p>{{ error }}</p>
      <button class="retry-btn" (click)="loadClientProfile()">
        <i class="fas fa-redo"></i> Retry
      </button>
    </div>
  </div>

  <div *ngIf="successMessage" class="success-container">
    <div class="success-message">
      <i class="fas fa-check-circle"></i>
      <p>{{ successMessage }}</p>
      <button class="close-btn" (click)="clearMessages()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <div *ngIf="clientProfile && !isLoading" class="profile-content">

    <div class="profile-header">
      <div class="profile-info">
        <div class="profile-avatar">
          <img [src]="clientProfile.profilePicture || 'assets/profile.png'"
               [alt]="clientProfile.fullName"
               class="avatar-img">
        </div>
        <div class="profile-details">
          <h1 class="profile-name">{{ clientProfile.fullName }}</h1>
          <p class="profile-email">{{ clientProfile.email }}</p>
          <span class="profile-status" [class.active]="clientProfile.isActive">
            <i class="fas fa-circle"></i>
            {{ clientProfile.isActive ? 'Active' : 'Inactive' }}
          </span>
        </div>
      </div>

      <div class="profile-actions">
        <button *ngIf="!isEditMode" class="btn btn-primary" (click)="onEditProfile()">
          <i class="fas fa-edit"></i>
          Edit Profile
        </button>
        <button *ngIf="isEditMode" class="btn btn-success" (click)="onSaveProfile()" [disabled]="isUpdating">
          <i class="fas fa-save"></i>
          <span *ngIf="!isUpdating">Save Changes</span>
          <span *ngIf="isUpdating">Saving...</span>
        </button>
        <button *ngIf="isEditMode" class="btn btn-outline" (click)="onCancelEdit()" [disabled]="isUpdating">
          <i class="fas fa-times"></i>
          Cancel
        </button>
        <button *ngIf="!isEditMode" class="btn btn-secondary" (click)="onAddAddress()">
          <i class="fas fa-plus"></i>
          Add Address
        </button>
      </div>
    </div>

    <div class="profile-cards">

      <div class="info-card">
        <div class="card-header">
          <h3><i class="fas fa-user"></i> Personal Information</h3>
        </div>
        <div class="card-body">
          <div *ngIf="!isEditMode">
            <div class="info-row">
              <span class="info-label">User ID:</span>
              <span class="info-value">{{ clientProfile.userId }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">First Name:</span>
              <span class="info-value">{{ clientProfile.firstName }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Last Name:</span>
              <span class="info-value">{{ clientProfile.lastName }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Email:</span>
              <span class="info-value">{{ clientProfile.email }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Phone:</span>
              <span class="info-value">{{ clientProfile.phone }}</span>
            </div>
          </div>

          <div *ngIf="isEditMode" class="edit-form">
            <div class="form-group">
              <label for="firstName">First Name:</label>
              <input
                type="text"
                id="firstName"
                [(ngModel)]="editForm.firstName"
                class="form-control"
                placeholder="Enter first name"
                [disabled]="isUpdating">
            </div>
            <div class="form-group">
              <label for="lastName">Last Name:</label>
              <input
                type="text"
                id="lastName"
                [(ngModel)]="editForm.lastName"
                class="form-control"
                placeholder="Enter last name"
                [disabled]="isUpdating">
            </div>
            <div class="form-group">
              <label for="email">Email:</label>
              <input
                type="email"
                id="email"
                [(ngModel)]="editForm.email"
                class="form-control"
                placeholder="Enter email address"
                [disabled]="isUpdating">
            </div>
            <div class="form-group">
              <label for="phone">Phone:</label>
              <input
                type="tel"
                id="phone"
                [(ngModel)]="editForm.phone"
                class="form-control"
                placeholder="Enter phone number"
                [disabled]="isUpdating">
            </div>
          </div>
        </div>
      </div>

      <div class="info-card" *ngIf="clientProfile.defaultAddress">
        <div class="card-header">
          <h3><i class="fas fa-map-marker-alt"></i> Default Address</h3>
        </div>
        <div class="card-body">
          <div class="info-row">
            <span class="info-label">Address ID:</span>
            <span class="info-value">{{ clientProfile.defaultAddress.id }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Address:</span>
            <span class="info-value">{{ clientProfile.defaultAddress.address }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">City:</span>
            <span class="info-value">{{ clientProfile.defaultAddress.city }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Address Type:</span>
            <span class="info-value">{{ clientProfile.defaultAddress.addressType }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Coordinates:</span>
            <span class="info-value">
              {{ clientProfile.defaultAddress.latitude }}, {{ clientProfile.defaultAddress.longitude }}
            </span>
          </div>
        </div>
      </div>
      <div class="info-card" *ngIf="!clientProfile.defaultAddress && clientProfile.addresses.length > 0">
        <div class="card-header">
          <h3><i class="fas fa-map-marker-alt"></i> Default Address</h3>
        </div>
        <div class="card-body">
          <p class="no-addresses">No default address set. Please set one from "All Addresses".</p>
        </div>
      </div>
      <div class="info-card" *ngIf="!clientProfile.defaultAddress && clientProfile.addresses.length === 0">
        <div class="card-header">
          <h3><i class="fas fa-map-marker-alt"></i> Default Address</h3>
        </div>
        <div class="card-body">
          <p class="no-addresses">No addresses added yet.</p>
        </div>
      </div>


      <div class="info-card">
        <div class="card-header">
          <h3><i class="fas fa-info-circle"></i> Account Information</h3>
        </div>
        <div class="card-body">
          <div class="info-row">
            <span class="info-label">Account Status:</span>
            <span class="info-value">
              <span class="status-badge" [class.active]="clientProfile.isActive">
                {{ clientProfile.isActive ? 'Active' : 'Inactive' }}
              </span>
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">Created At:</span>
            <span class="info-value">{{ formatDate(clientProfile.createdAt) }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Last Updated:</span>
            <span class="info-value">{{ formatDate(clientProfile.updatedAt) }}</span>
          </div>
        </div>
      </div>

      <div class="info-card addresses-section" *ngIf="clientProfile.addresses && clientProfile.addresses.length > 0">
        <div class="card-header">
          <h3><i class="fas fa-map-marker-alt"></i> All Addresses</h3>
        </div>
        <div class="card-body">
          <div class="addresses-grid">
            <div class="address-card"
                *ngFor="let address of clientProfile.addresses"
                [class.default]="address.isDefault">
              <div class="address-card-header">
                <span class="address-type" [class.default]="address.isDefault">
                  {{ address.addressType }}
                </span>
                <div class="address-actions">
                  <button class="btn btn-primary btn-small" (click)="onEditAddress(address)" [disabled]="isAddingAddress">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button class="btn btn-secondary btn-small" (click)="onDeleteAddress(address.id)" [disabled]="isDeletingAddress">
                    <i class="fas fa-trash-alt"></i> Delete
                  </button>
                  <button *ngIf="!address.isDefault" class="btn btn-outline btn-small" (click)="onSetDefaultAddress(address)" [disabled]="isSettingDefault">
                    <i class="fas fa-thumbtack"></i> Set Default
                  </button>
                </div>
              </div>
              <div class="address-details">
                {{ address.address }}, {{ address.city }}
              </div>
              <div class="address-coordinates">
                {{ address.latitude }}, {{ address.longitude }}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="info-card addresses-section" *ngIf="!clientProfile.addresses || clientProfile.addresses.length === 0">
        <div class="card-header">
          <h3><i class="fas fa-map-marker-alt"></i> All Addresses</h3>
        </div>
        <div class="card-body">
          <p class="no-addresses">You have no saved addresses. Click "Add Address" to add one.</p>
        </div>
      </div>

    </div>
  </div>

  <div *ngIf="showAddressModal" class="modal-overlay" (click)="onCancelAddAddress()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <i class="fas fa-map-marker-alt"></i>
          {{ isEditAddressMode ? 'Edit Address' : 'Add New Address' }}
        </h2>
        <button class="close-btn" (click)="onCancelAddAddress()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <form class="address-form">
          <div class="form-group">
            <label for="address1">Address <span class="required">*</span></label>
            <input
              type="text"
              id="address1"
              [(ngModel)]="addressForm.address1"
              name="address1"
              class="form-control"
              placeholder="Enter full address"
              [disabled]="isAddingAddress"
              required>
          </div>

          <div class="form-group">
            <label for="city">City <span class="required">*</span></label>
            <input
              type="text"
              id="city"
              [(ngModel)]="addressForm.city"
              name="city"
              class="form-control"
              placeholder="Enter city"
              [disabled]="isAddingAddress"
              required>
          </div>

          <div class="form-group">
            <label for="addressType">Address Type <span class="required">*</span></label>
            <select
              id="addressType"
              [(ngModel)]="addressForm.addressType"
              name="addressType"
              class="form-control"
              [disabled]="isAddingAddress"
              required>
              <option value="Home">Home</option>
              <option value="Work">Work</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="latitude">Latitude</label>
              <input
                type="number"
                id="latitude"
                [(ngModel)]="addressForm.latitude"
                name="latitude"
                class="form-control"
                placeholder="0.00"
                step="0.000001"
                [disabled]="isAddingAddress">
            </div>

            <div class="form-group">
              <label for="longitude">Longitude</label>
              <input
                type="number"
                id="longitude"
                [(ngModel)]="addressForm.longitude"
                name="longitude"
                class="form-control"
                placeholder="0.00"
                step="0.000001"
                [disabled]="isAddingAddress">
            </div>
          </div>

          <div class="form-group">
            <button
              type="button"
              class="btn btn-outline btn-location"
              (click)="getCurrentLocation()"
              [disabled]="isAddingAddress">
              <i class="fas fa-location-arrow"></i>
              Get Current Location
            </button>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [(ngModel)]="addressForm.isDefault"
                name="isDefault"
                [disabled]="isAddingAddress">
              <span class="checkmark"></span>
              Set as default address
            </label>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline"
          (click)="onCancelAddAddress()"
          [disabled]="isAddingAddress">
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="isEditAddressMode ? onUpdateAddress() : onSaveAddress()"
          [disabled]="isAddingAddress">
          <i class="fas fa-save"></i>
          <span *ngIf="!isAddingAddress">
            {{ isEditAddressMode ? 'Update Address' : 'Save Address' }}
          </span>
          <span *ngIf="isAddingAddress">
            {{ isEditAddressMode ? 'Updating...' : 'Adding...' }}
          </span>
        </button>
      </div>
    </div>
  </div>
</div>